import 'dart:convert';
import 'dart:io';
import 'package:http/http.dart' as http;

class AIService {
  static const String _openaiBaseUrl = 'https://api.openai.com/v1';
  static const String _deepseekBaseUrl = 'https://api.deepseek.com/v1';
  
  // Ø³ÙŠØªÙ… Ø¬Ù„Ø¨ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù…Ù† Firebase
  static String? _openaiApiKey;
  static String? _deepseekApiKey;
  
  // Ù†ÙˆØ¹ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  static AIProvider _currentProvider = AIProvider.openai;
  
  // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙØ§ØªÙŠØ­ API
  static void setApiKeys({String? openaiKey, String? deepseekKey}) {
    _openaiApiKey = openaiKey;
    _deepseekApiKey = deepseekKey;
  }
  
  // ØªØºÙŠÙŠØ± Ù…Ø²ÙˆØ¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
  static void setProvider(AIProvider provider) {
    _currentProvider = provider;
  }
  
  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
  static Future<String> getChatResponse(String userMessage, {List<ChatMessage>? conversationHistory}) async {
    try {
      switch (_currentProvider) {
        case AIProvider.openai:
          return await _getOpenAIResponse(userMessage, conversationHistory);
        case AIProvider.deepseek:
          return await _getDeepSeekResponse(userMessage, conversationHistory);
        default:
          return _getFallbackResponse(userMessage);
      }
    } catch (e) {
      print('Ø®Ø·Ø£ ÙÙŠ AI Service: $e');
      return _getFallbackResponse(userMessage);
    }
  }
  
  // Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ù† OpenAI/ChatGPT
  static Future<String> _getOpenAIResponse(String userMessage, List<ChatMessage>? history) async {
    if (_openaiApiKey == null || _openaiApiKey!.isEmpty) {
      return _getFallbackResponse(userMessage);
    }
    
    try {
      final messages = _buildConversationMessages(userMessage, history);
      
      final response = await http.post(
        Uri.parse('$_openaiBaseUrl/chat/completions'),
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer $_openaiApiKey',
        },
        body: jsonEncode({
          'model': 'gpt-3.5-turbo',
          'messages': messages,
          'max_tokens': 500,
          'temperature': 0.7,
          'system': _getSystemPrompt(),
        }),
      );
      
      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        final content = data['choices'][0]['message']['content'];
        return content?.trim() ?? _getFallbackResponse(userMessage);
      } else {
        print('Ø®Ø·Ø£ OpenAI: ${response.statusCode} - ${response.body}');
        return _getFallbackResponse(userMessage);
      }
    } catch (e) {
      print('Ø®Ø·Ø£ ÙÙŠ OpenAI: $e');
      return _getFallbackResponse(userMessage);
    }
  }
  
  // Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ù† DeepSeek
  static Future<String> _getDeepSeekResponse(String userMessage, List<ChatMessage>? history) async {
    if (_deepseekApiKey == null || _deepseekApiKey!.isEmpty) {
      return _getFallbackResponse(userMessage);
    }
    
    try {
      final messages = _buildConversationMessages(userMessage, history);
      
      final response = await http.post(
        Uri.parse('$_deepseekBaseUrl/chat/completions'),
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer $_deepseekApiKey',
        },
        body: jsonEncode({
          'model': 'deepseek-chat',
          'messages': messages,
          'max_tokens': 500,
          'temperature': 0.7,
          'stream': false,
        }),
      );
      
      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        final content = data['choices'][0]['message']['content'];
        return content?.trim() ?? _getFallbackResponse(userMessage);
      } else {
        print('Ø®Ø·Ø£ DeepSeek: ${response.statusCode} - ${response.body}');
        return _getFallbackResponse(userMessage);
      }
    } catch (e) {
      print('Ø®Ø·Ø£ ÙÙŠ DeepSeek: $e');
      return _getFallbackResponse(userMessage);
    }
  }
  
  // Ø¨Ù†Ø§Ø¡ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ù„Ù€ API
  static List<Map<String, String>> _buildConversationMessages(String userMessage, List<ChatMessage>? history) {
    List<Map<String, String>> messages = [
      {
        'role': 'system',
        'content': _getSystemPrompt(),
      }
    ];
    
    // Ø¥Ø¶Ø§ÙØ© ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (Ø¢Ø®Ø± 10 Ø±Ø³Ø§Ø¦Ù„ ÙÙ‚Ø· Ù„ØªÙˆÙÙŠØ± Ø§Ù„ØªÙƒÙ„ÙØ©)
    if (history != null && history.isNotEmpty) {
      final recentHistory = history.length > 10 ? history.sublist(history.length - 10) : history;
      
      for (final message in recentHistory) {
        messages.add({
          'role': message.isUser ? 'user' : 'assistant',
          'content': message.text,
        });
      }
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    messages.add({
      'role': 'user',
      'content': userMessage,
    });
    
    return messages;
  }
  
  // Ø§Ù„Ù†Øµ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ÙŠ Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
  static String _getSystemPrompt() {
    return '''Ø£Ù†Øª Ø¨ÙˆØª Ù…ÙŠÙ… Ø§Ù„Ø°ÙƒÙŠØŒ Ù…Ø³Ø§Ø¹Ø¯ Ù…ØªØ®ØµØµ ÙÙŠ Ø±ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©.

Ù…Ù‡Ù…ØªÙƒ:
- Ù…Ø³Ø§Ø¹Ø¯Ø© Ø±ÙˆØ§Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ ÙÙŠ ØªØ·ÙˆÙŠØ± Ù…Ø´Ø§Ø±ÙŠØ¹Ù‡Ù…
- ØªÙ‚Ø¯ÙŠÙ… Ù†ØµØ§Ø¦Ø­ Ø¹Ù…Ù„ÙŠØ© ÙˆÙ…ÙÙŠØ¯Ø©
- Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ„ ÙˆØ§Ù„ØªØ³ÙˆÙŠÙ‚ ÙˆØ¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ‰
- Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø¨Ø±Ø© ÙˆØ¯ÙˆØ¯Ø© ÙˆØªØ´Ø¬ÙŠØ¹ÙŠØ©
- Ø§Ù„Ø±Ø¯ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹

ØªØ®ØµØµØ§ØªÙƒ:
- ØªØ·ÙˆÙŠØ± Ø£ÙÙƒØ§Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
- Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ‰ Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠØ©
- Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªÙ…ÙˆÙŠÙ„ ÙˆØ§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±
- Ø®Ø·Ø· Ø§Ù„ØªØ³ÙˆÙŠÙ‚ ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
- ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ÙØ³ÙŠÙ† ÙˆØ§Ù„Ø£Ø³ÙˆØ§Ù‚
- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙˆØ§Ù„ÙØ±Ù‚

Ø£Ø³Ù„ÙˆØ¨Ùƒ:
- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠØ© Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø§Ø³Ø¨
- Ù‚Ø¯Ù… Ù†ØµØ§Ø¦Ø­ Ø¹Ù…Ù„ÙŠØ© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
- Ø§Ø·Ø±Ø­ Ø£Ø³Ø¦Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
- Ø´Ø¬Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ø¯Ø¹Ù… Ø«Ù‚ØªÙ‡ Ø¨Ù†ÙØ³Ù‡
- Ø§Ø³ØªØ®Ø¯Ù… Ø£Ù…Ø«Ù„Ø© ÙˆØ§Ù‚Ø¹ÙŠØ© Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ø°Ù„Ùƒ Ù…ÙÙŠØ¯Ø§Ù‹

ØªØ°ÙƒØ±: Ù‡Ø¯ÙÙƒ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø±ÙˆØ§Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø¹Ù„Ù‰ ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù†Ø¬Ø§Ø­!''';
  }
  
  // Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¹Ù†Ø¯ ÙØ´Ù„ Ø§Ù„Ù€ APIs
  static String _getFallbackResponse(String userMessage) {
    final message = userMessage.toLowerCase();
    
    // Ø§Ø³ØªØ¬Ø§Ø¨Ø§Øª Ø°ÙƒÙŠØ© Ù…Ø­Ù„ÙŠØ©
    if (message.contains('Ù…Ø´Ø±ÙˆØ¹') || message.contains('ÙÙƒØ±Ø©')) {
      return 'ÙÙƒØ±Ø© Ø±Ø§Ø¦Ø¹Ø©! ğŸ’¡ Ù„ØªØ·ÙˆÙŠØ± Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø£Ù†ØµØ­Ùƒ Ø¨Ø§Ù„ØªØ§Ù„ÙŠ:\n\n'
             '1ï¸âƒ£ Ø§Ø¨Ø¯Ø£ Ø¨Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù\n'
             '2ï¸âƒ£ Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªÙŠ ÙŠØ­Ù„Ù‡Ø§ Ù…Ø´Ø±ÙˆØ¹Ùƒ\n'
             '3ï¸âƒ£ Ø§Ø¹Ù…Ù„ Ø¯Ø±Ø§Ø³Ø© Ø¬Ø¯ÙˆÙ‰ Ù…ÙØµÙ„Ø©\n'
             '4ï¸âƒ£ Ø¶Ø¹ Ø®Ø·Ø© ØªØ³ÙˆÙŠÙ‚ÙŠØ© ÙˆØ§Ø¶Ø­Ø©\n\n'
             'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø£ÙŠ Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ù†Ù‚Ø§Ø·ØŸ';
    }
    
    if (message.contains('ØªÙ…ÙˆÙŠÙ„') || message.contains('Ø§Ø³ØªØ«Ù…Ø§Ø±')) {
      return 'Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø®Ø·ÙˆØ© Ù…Ù‡Ù…Ø©! ğŸ’° Ø¥Ù„ÙŠÙƒ Ø£Ù‡Ù… Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªÙ…ÙˆÙŠÙ„:\n\n'
             'ğŸ¦ Ø§Ù„Ù‚Ø±ÙˆØ¶ Ø§Ù„Ø¨Ù†ÙƒÙŠØ©\n'
             'ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±ÙŠÙ† Ø§Ù„Ù…Ù„Ø§Ø¦ÙƒØ©\n'
             'ğŸ¢ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±\n'
             'ğŸ¯ Ø§Ù„Ù…Ù†Ø­ Ø§Ù„Ø­ÙƒÙˆÙ…ÙŠØ©\n'
             'ğŸ’³ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ\n\n'
             'Ù…Ø§ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø°ÙŠ ØªØ®Ø·Ø· Ù„Ù‡ØŸ Ø³Ø£Ø³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ù†Ø³Ø¨!';
    }
    
    if (message.contains('ØªØ³ÙˆÙŠÙ‚') || message.contains('Ø¹Ù…Ù„Ø§Ø¡')) {
      return 'Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ù…ÙØªØ§Ø­ Ø§Ù„Ù†Ø¬Ø§Ø­! ğŸ“ˆ Ø¥Ù„ÙŠÙƒ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª ÙØ¹Ø§Ù„Ø©:\n\n'
             'ğŸ“± Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ø§Ù„Ø±Ù‚Ù…ÙŠ (ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„)\n'
             'ğŸ¯ Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù\n'
             'ğŸ¤ Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ø¨Ø§Ù„Ù…Ø­ØªÙˆÙ‰\n'
             'â­ ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ù…ÙŠØ²Ø©\n'
             'ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬\n\n'
             'Ø£Ø®Ø¨Ø±Ù†ÙŠ Ø¹Ù† Ø¬Ù…Ù‡ÙˆØ±Ùƒ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù ÙˆØ³Ø£Ù‚ØªØ±Ø­ Ø®Ø·Ø© Ù…Ø®ØµØµØ©!';
    }
    
    // Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø¹Ø§Ù…Ø©
    return 'Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ Ø¹Ù„Ù‰ Ø³Ø¤Ø§Ù„Ùƒ! ğŸ˜Š\n\n'
           'Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø¬ÙˆØ§Ù†Ø¨ Ø±ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„. '
           'ÙŠÙ…ÙƒÙ†Ùƒ Ø³Ø¤Ø§Ù„ÙŠ Ø¹Ù†:\n\n'
           'â€¢ ØªØ·ÙˆÙŠØ± Ø£ÙÙƒØ§Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹\n'
           'â€¢ Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ‰\n'
           'â€¢ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ³ÙˆÙŠÙ‚\n'
           'â€¢ Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªÙ…ÙˆÙŠÙ„\n'
           'â€¢ Ø­Ù„ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©\n\n'
           'ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø¨Ø´ÙƒÙ„ Ø£ÙƒØ«Ø± ØªØ­Ø¯ÙŠØ¯Ø§Ù‹ØŸ';
  }
  
  // Ø§Ø®ØªØ¨Ø§Ø± Ø§ØªØµØ§Ù„ API
  static Future<bool> testConnection(AIProvider provider) async {
    try {
      final testMessage = "Ù…Ø±Ø­Ø¨Ø§";
      final response = await getChatResponse(testMessage);
      return response.isNotEmpty;
    } catch (e) {
      return false;
    }
  }
  
  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
  static Future<Map<String, dynamic>> getUsageStats() async {
    // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ù„Ø¬Ù„Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù† Firebase
    return {
      'total_messages': 0,
      'tokens_used': 0,
      'cost_estimate': 0.0,
    };
  }
}

// Ø£Ù†ÙˆØ§Ø¹ Ù…Ø²ÙˆØ¯ÙŠ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
enum AIProvider {
  openai,
  deepseek,
}

// Ù†Ù…ÙˆØ°Ø¬ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
class ChatMessage {
  final String text;
  final bool isUser;
  final DateTime timestamp;

  ChatMessage({
    required this.text,
    required this.isUser,
    required this.timestamp,
  });
  
  Map<String, dynamic> toJson() {
    return {
      'text': text,
      'isUser': isUser,
      'timestamp': timestamp.toIso8601String(),
    };
  }
  
  factory ChatMessage.fromJson(Map<String, dynamic> json) {
    return ChatMessage(
      text: json['text'],
      isUser: json['isUser'],
      timestamp: DateTime.parse(json['timestamp']),
    );
  }
}